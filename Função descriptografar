#include <stdlib.h>
#include <stdio.h>
#define MAX 15

int descriptografar(char*, char comentarioA[MAX][20], char loginA[MAX][20], char senhaA[MAX][30], char*, int);

//entrada pra teste da função
int main()
{
	char senhaM[10], nomeIMG[30];
	char comentarioA[MAX][20];
	char loginA[MAX][20];
	char senhaA[MAX][30];
	int contador = 2;
	
	printf("senha: ");
	gets(senhaM);
	printf("nome da imagem: ");
	gets(nomeIMG);	
	
	descriptografar(senhaM, comentarioA, loginA, senhaA, nomeIMG, contador);
	
	return 0;
}


int descriptografar(char *senha, char comentarioA[MAX][20], char loginA[MAX][20], char senhaA[MAX][30], char *nome, int contador)
{
	int tamanho_senha = 0, maior_letra = 0, menor_letra = 255, soma = 0, contador_char = 0; 			//<<contar caracteres a criptografar; 
	int *posicao_senha, i, j, posicao_contador[5], valor_contador[5], nova_posicao, ultima_posicao; 	//guardar junto da senha pra saber até onde descriptografar
	int posicao_comentarioA[MAX][20], tam_comentarioA[MAX], pos_tam_comentarioA[MAX];
	int posicao_loginA[MAX][20], tam_loginA[MAX], pos_tam_loginA[MAX];
	int posicao_senhaA[MAX][20], tam_senhaA[MAX], pos_tam_senhaA[MAX];
	int senha_confere = 0, posicao_tamanho_senha, tamanho_senha_crip = 0, contador_senha = 0;
	char *senha_crip, *senha_digitada;
	FILE *img_copia;
	
	//achar tamanho da senha
	while (senha[tamanho_senha] != '\0')
	{
		tamanho_senha++;
	}
	posicao_senha = (int*) malloc(tamanho_senha*sizeof(int));
	senha_crip = (char*) malloc(tamanho_senha*sizeof(char));
	senha_digitada = (char*) malloc(tamanho_senha*sizeof(char));
	
	//achar maior e menor caracteres da senha
	for (i=0; i<tamanho_senha; i++)
	{
		senha_digitada[i] = senha[i];
		if (maior_letra < senha[i])
		{
			maior_letra = senha[i];
		}
		if (menor_letra > senha[i])
		{
			menor_letra = senha[i];
		}
		soma += senha[i];
	}
	
	//mudar posições dos caracteres da senha na imagem
	nova_posicao = tamanho_senha*(maior_letra-menor_letra) + soma;
	posicao_tamanho_senha = nova_posicao + 18;
	for (i=0; i<tamanho_senha; i++)
	{
		if (i == 0)
		{
			posicao_senha[i] = nova_posicao;
		}
		else
		{
			posicao_senha[i] = posicao_senha[i-1] + nova_posicao;
		}
		
		senha[i] = senha[i] + (i+3) - menor_letra;
	}
	
	//achar tamanho de cada campo preenchido
/*	for (i=0; i<10n_campo; i++)
	{
		tam_campo[i] = 0;
		while (campo[i][tam_campo[i]] != '\0')
		{
			tam_campo[i]++;
			contador_char++;
		}
	}
*/	
	//quantidade de caracteres preenchidos
	ultima_posicao = posicao_senha[tamanho_senha-1];
	for (i=0; i<5; i++)
	{
/*		if (contador_char >= 255)
		{
			valor_contador[i] = 255 - menor_letra + tamanho_senha;
			contador_char -= (255 - menor_letra + tamanho_senha);
		}
		else if (contador_char > 0 && contador_char < 255)
		{
			valor_contador[i] = contador_char;
			contador_char = 0;
		}
		else
		{
			valor_contador[i] = 0;
		}
*/		posicao_contador[i] = ultima_posicao + nova_posicao;
		ultima_posicao = posicao_contador[i];
	}
	
	//local dos tamanhos de cada campo
	for (i=0; i<contador; i++)
	{
		pos_tam_comentarioA[i] = tamanho_senha*(maior_letra-menor_letra) + soma + 1 + i;
		pos_tam_loginA[i] = tamanho_senha*(maior_letra-menor_letra) + soma + 21 + i;
		pos_tam_senhaA[i] = tamanho_senha*(maior_letra-menor_letra) + soma + 41 + i;
	}		
	
	//**************IMAGEM****************
	
	
	img_copia = fopen(nome, "r+");
	
	//extrair senha
	fseek(img_copia, posicao_tamanho_senha, SEEK_SET);
	fread(&tamanho_senha_crip, 1, 1, img_copia);
	tamanho_senha_crip -= (maior_letra-menor_letra);
	for (i=0; i<tamanho_senha; i++)
	{
		fseek(img_copia, posicao_senha[i], SEEK_SET);
		fread(&senha_crip[i], 1, 1, img_copia);
		senha_crip[i] = senha_crip[i] + menor_letra - (i+3);
	}
	
	//conferir senha	
	if (tamanho_senha_crip == tamanho_senha)
	{												
		for (i=0; i<tamanho_senha; i++)
		{
			if (senha_crip[i] == senha_digitada[i])
			{
				contador_senha++;
			}
		}
		if (contador_senha == tamanho_senha_crip)
		{
			senha_confere = 1;
		}
	}
	
	if (senha_confere == 0)
	{
		printf("Senha nao encontrada.\n");
	}
	else
	{
		//extrair tamanho de cada campo
		for (i=0; i<contador; i++)
		{
			tam_comentarioA[i] = 0;
			tam_loginA[i] = 0;
			tam_senhaA[i] = 0;
			fseek(img_copia, pos_tam_comentarioA[i], SEEK_SET);
			fread(&tam_comentarioA[i], 1, 1, img_copia);
printf("tam_comentarioA[%d]: %d\n", i, tam_comentarioA[i]);
			fseek(img_copia, pos_tam_loginA[i], SEEK_SET);
			fread(&tam_loginA[i], 1, 1, img_copia);
printf("tam_loginA[%d]: %d\n", i, tam_loginA[i]);
			fseek(img_copia, pos_tam_senhaA[i], SEEK_SET);
			fread(&tam_senhaA[i], 1, 1, img_copia);
printf("tam_senhaA[%d]: %d\n\n", i, tam_senhaA[i]);
		}
		//extrair qtd caracteres
/*		for (i=0; i<5; i++)
		{
			valor_contador[i] = 0;
			fseek(img_copia, posicao_contador[i], SEEK_SET);
			fread(&valor_contador[i], 1, 1, img_copia);
			contador_char += valor_contador[i];
		}
		int posicao_campo[contador_char];
		char campo[contador_char];				*/
		
		//mudar posição dos caracteres de cada campo
		for (i=0; i<contador; i++)
		{
			if (tam_comentarioA[i] > 0)
			{
				for (j=0; j<tam_comentarioA[i]; j++)
				{
					posicao_comentarioA[i][j] = ultima_posicao + nova_posicao;
					ultima_posicao = posicao_comentarioA[i][j];
					comentarioA[i][j] = comentarioA[i][j] - (menor_letra + maior_letra)/10;
				}
			}
			if (tam_loginA[i] > 0)
			{
				for (j=0; j<tam_loginA[i]; j++)
				{
//printf("tam_loginA[%d]: %d\n", j, tam_loginA[i]);
					posicao_loginA[i][j] = ultima_posicao + nova_posicao;
					ultima_posicao = posicao_loginA[i][j];
					loginA[i][j] = loginA[i][j] - (menor_letra + maior_letra)/10;
				}
			}
			if (tam_senhaA[i] > 0)
			{
				for (j=0; j<tam_senhaA[i]; j++)
				{
					posicao_senhaA[i][j] = ultima_posicao + nova_posicao;
					ultima_posicao = posicao_senhaA[i][j];
					senhaA[i][j] = senhaA[i][j] - (menor_letra + maior_letra)/10;
				}
			}
		}
	
		//extrair caracteres
		for (i=0; i<contador; i++)
		{
			if (tam_comentarioA[i] > 0)
			{
				for (j=0; j<tam_comentarioA[i]; j++)
				{
				fseek(img_copia, posicao_comentarioA[i][j], SEEK_SET);
				fread(&comentarioA[i][j], 1, 1, img_copia);
				comentarioA[i][j] = comentarioA[i][j] - (menor_letra + maior_letra)/10;
				}
			}
			if (tam_loginA[i] > 0)
			{
				for (j=0; j<tam_loginA[i]; j++)
				{
				fseek(img_copia, posicao_loginA[i][j], SEEK_SET);
				fread(&loginA[i][j], 1, 1, img_copia);
				loginA[i][j] = loginA[i][j] - (menor_letra + maior_letra)/10;
				}
			}
			if (tam_senhaA[i] > 0)
			{
				for (j=0; j<tam_senhaA[i]; j++)
				{
				fseek(img_copia, posicao_senhaA[i][j], SEEK_SET);
				fread(&senhaA[i][j], 1, 1, img_copia);
				senhaA[i][j] = senhaA[i][j] - (menor_letra + maior_letra)/10;
				}
			}
		}				
	}	
	
	//TESTE - leitura do que foi extraído da imagem
	for (i=0; i<contador; i++)
	{
		printf("i=%d:\n", i);
		if (tam_comentarioA[i] > 0)
		{
			puts(comentarioA[i]);
		}
		if (tam_loginA[i] > 0)
		{
			puts(loginA[i]);
		}
		if (tam_senhaA[i] > 0)
		{
			puts(senhaA[i]);
		}
	}	
	
	fclose(img_copia);
	system("PAUSE");
	return senha_confere;
}
