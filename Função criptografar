#include <stdlib.h>
#include <stdio.h>
#define MAX 15

int criptografar(char*, char comentarioA[MAX][20], char loginA[MAX][20], char senhaA[MAX][30], int);

//entrada pra teste da função
int main()
{
	char comentarioA[MAX][20];
	char loginA[MAX][20];
	char senhaA[MAX][30];
	
	char senhaM[10];
	int imageE;
	int i, j;
	
	printf("senha: ");
	gets(senhaM);
	
	printf("imagem (1, 2, 3 ou 4): ");
	scanf("%d", &imageE);
	getchar();
	
	printf("comentarioA[0]: ");
	gets(comentarioA[0]);
	printf("comentarioA[1]: ");
	gets(comentarioA[1]);
	printf("loginA[0]: ");
	gets(loginA[0]);
	printf("loginA[1]: ");
	gets(loginA[1]);
	printf("senhaA[0]: ");
	gets(senhaA[0]);
	printf("senhaA[1]: ");
	gets(senhaA[1]);	
	criptografar(senhaM, comentarioA, loginA, senhaA, imageE);
	
	return 0;
}


int criptografar(char *senha, char comentarioA[MAX][20], char loginA[MAX][20], char senhaA[MAX][30], int imagem)
{
	int tamanho_senha = 0, maior_letra = 0, menor_letra = 255, soma = 0, contador_char = 0;				//<<contar caracteres a criptografar; 
	int *posicao_senha, i, j, nova_posicao, ultima_posicao, valor_contador[5], posicao_contador[5];		//guardar junto da senha pra saber até onde descriptografar
	int posicao_comentarioA[MAX][20], tam_comentarioA[MAX], pos_tam_comentarioA[MAX];
	int posicao_loginA[MAX][20], tam_loginA[MAX], pos_tam_loginA[MAX];
	int posicao_senhaA[MAX][20], tam_senhaA[MAX], pos_tam_senhaA[MAX];
	int final_img, copiar, posicao_tamanho_senha, tamanho_senha_crip;
	FILE *img_original, *img_copia;
	
	//achar tamanho da senha
	while (senha[tamanho_senha] != '\0')
	{
		tamanho_senha++;
	}
	posicao_senha = (int*) malloc(tamanho_senha*sizeof(int));
	
	//achar maior e menor caracteres da senha
	for (i=0; i<tamanho_senha; i++)
	{
		if (maior_letra < senha[i])
		{
			maior_letra = senha[i];
		}
		if (menor_letra > senha[i])
		{
			menor_letra = senha[i];
		}
		soma += senha[i];
	}
	
	//mudar valor dos caracteres da senha e posições na imagem
	nova_posicao = tamanho_senha*(maior_letra-menor_letra) + soma;
	posicao_tamanho_senha = nova_posicao + 18;
	for (i=0; i<tamanho_senha; i++)
	{
		if (i == 0)
		{
			posicao_senha[i] = nova_posicao;
		}
		else
		{
			posicao_senha[i] = posicao_senha[i-1] + nova_posicao;
		}
		
		senha[i] = senha[i] + (i+3) - menor_letra;
	}
	
	//achar tamanho de cada campo preenchido
	for (i=0; i<MAX; i++)
	{
		tam_comentarioA[i] = 0;
		while (comentarioA[i][tam_comentarioA[i]] != '\0')
		{
			tam_comentarioA[i]++;
			contador_char++;
		}
		tam_loginA[i] = 0;
		while (loginA[i][tam_loginA[i]] != '\0')
		{
			tam_loginA[i]++;
			contador_char++;
		}
		tam_senhaA[i] = 0;
		while (senhaA[i][tam_senhaA[i]] != '\0')
		{
			tam_senhaA[i]++;
			contador_char++;
		}		
	}
	
	//quantidade de caracteres preenchidos
	ultima_posicao = posicao_senha[tamanho_senha-1];
	for (i=0; i<5; i++)
	{
		if (contador_char >= 255)
		{
			valor_contador[i] = 255 - menor_letra + tamanho_senha;
			contador_char -= (255 - menor_letra + tamanho_senha);
		}
		else if (contador_char > 0 && contador_char < 255)
		{
			valor_contador[i] = contador_char;
			contador_char = 0;
		}
		else
		{
			valor_contador[i] = 0;
		}
		posicao_contador[i] = ultima_posicao + nova_posicao;
		ultima_posicao = posicao_contador[i];
	}
	
	//local dos tamanhos de cada campo
	for (i=0; i<MAX; i++)
	{
		pos_tam_comentarioA[i] = tamanho_senha*(maior_letra-menor_letra) + soma + 1 + i;
		pos_tam_loginA[i] = tamanho_senha*(maior_letra-menor_letra) + soma + 21 + i;
		pos_tam_senhaA[i] = tamanho_senha*(maior_letra-menor_letra) + soma + 41 + i;
	}	
	
	//mudar valor e posição dos caracteres de cada campo
	for (i=0; i<MAX; i++)
	{
		if (tam_comentarioA[i] > 0)
		{
			for (j=0; j<tam_comentarioA[i]; j++)
			{
				posicao_comentarioA[i][j] = ultima_posicao + nova_posicao;
				ultima_posicao = posicao_comentarioA[i][j];
				comentarioA[i][j] = comentarioA[i][j] + (menor_letra + maior_letra)/10;
			}
		}
		if (tam_loginA[i] > 0)
		{
			for (j=0; j<tam_loginA[i]; j++)
			{
				posicao_loginA[i][j] = ultima_posicao + nova_posicao;
				ultima_posicao = posicao_loginA[i][j];
				loginA[i][j] = loginA[i][j] + (menor_letra + maior_letra)/10;
			}
		}
		if (tam_senhaA[i] > 0)
		{
			for (j=0; j<tam_senhaA[i]; j++)
			{
				posicao_senhaA[i][j] = ultima_posicao + nova_posicao;
				ultima_posicao = posicao_senhaA[i][j];
				senhaA[i][j] = senhaA[i][j] + (menor_letra + maior_letra)/10;
			}
		}
	}
	
	//**************IMAGEM****************
	
	switch (imagem)
	{
		case 1:
			img_original = fopen("img1.bmp", "r");
			break;
		case 2:
			img_original = fopen("img2.bmp", "r");
			break;
		case 3:
			img_original = fopen("img3.bmp", "r");
			break;
		case 4:
			img_original = fopen("img4.bmp", "r");
			break;
	}
	
	//tamanho da img
	fseek(img_original, 2, SEEK_SET);
 	fread(&final_img, 4, 1, img_original);
	
	//criar cópia da imagem pra fazer alterações
	img_copia = fopen("img crip.bmp", "w");
	for (i=0; i<final_img; i++)
	{
		fseek(img_original, i, SEEK_SET);
		fread(&copiar, 1, 1, img_original);
		fseek(img_copia, i, SEEK_SET);
		fwrite(&copiar, 1, 1, img_copia);
	}
	
	//guardar senha
	tamanho_senha_crip = tamanho_senha + (maior_letra-menor_letra);
	fseek(img_copia, posicao_tamanho_senha, SEEK_SET);
	fwrite(&tamanho_senha_crip, 1, 1, img_copia);
	for (i=0; i<tamanho_senha; i++)
	{
		fseek(img_copia, posicao_senha[i], SEEK_SET);
		fwrite(&senha[i], 1, 1, img_copia);
	}
	
	//guardar qtd caracteres
	for (i=0; i<5; i++)
	{
		fseek(img_copia, posicao_contador[i], SEEK_SET);
		fwrite(&valor_contador[i], 1, 1, img_copia);
	}
	
	//guardar tamanho campo
	for (i=0; i<MAX; i++)
	{
		fseek(img_copia, pos_tam_comentarioA[i], SEEK_SET);
		fwrite(&tam_comentarioA[i], 1, 1, img_copia);
		fseek(img_copia, pos_tam_loginA[i], SEEK_SET);
		fwrite(&tam_loginA[i], 1, 1, img_copia);
		fseek(img_copia, pos_tam_senhaA[i], SEEK_SET);
		fwrite(&tam_senhaA[i], 1, 1, img_copia);
	}
	
	//guardar caracteres
	for (i=0; i<MAX; i++)
	{
		if (tam_comentarioA[i] > 0)
		{
			for (j=0; j<tam_comentarioA[i]; j++)
			{	
				fseek(img_copia, posicao_comentarioA[i][j], SEEK_SET);
				fwrite(&comentarioA[i][j], 1, 1, img_copia);
			}			
		}
		if (tam_loginA[i] > 0)
		{
			for (j=0; j<tam_loginA[i]; j++)
			{	
				fseek(img_copia, posicao_loginA[i][j], SEEK_SET);
				fwrite(&loginA[i][j], 1, 1, img_copia);
			}			
		}
		if (tam_senhaA[i] > 0)
		{
			for (j=0; j<tam_senhaA[i]; j++)
			{	
				fseek(img_copia, posicao_senhaA[i][j], SEEK_SET);
				fwrite(&senhaA[i][j], 1, 1, img_copia);
			}			
		}		
	}
	
	fclose(img_original);
	fclose(img_copia);
	system("PAUSE");
	return 0;
}

